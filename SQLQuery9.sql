use NORTHWIND
go

CREATE PROCEDURE dbo.SP_04_Cursores_Monto_por_Ordenes_por_Ano AS



-- DECLARO VARIABLES DE TRABAJO

DECLARE @Y INT, @Y1 INT, @PEDIDO INT, @MONTO DECIMAL, @TOTAL

DECIMAL

SET @TOTAL=0

-- DECLARO EL CURSOR

DECLARE MI_CURSOR CURSOR FOR

SELECT YEAR(D.OrderDate),

 C.OrderID,

 SUM(C.Quantity * C.UnitPrice)

FROM [Order Details] C

JOIN Orders D ON C.OrderID=D.OrderID

GROUP BY YEAR(D.OrderDate), C.OrderID

ORDER BY 1

-- ABRIR EL CURSOR

OPEN MI_CURSOR

-- LEER EL PRIMER REGISTRO

FETCH MI_CURSOR INTO @Y, @PEDIDO, @MONTO 

-- ASIGNAR A LA VARIABLE @Y1 EL VALOR INICIAL DE @Y

SET @Y1 = @Y

-- IMPRIMIR EL PRIMER A�O

PRINT 'A�O:' + CAST(@Y1 AS VARCHAR)

-- MIENTRAS PUEDA LEER EL REGISTRO

WHILE @@FETCH_STATUS=0

BEGIN

-- SI COINCIDEN LOS VALORES ACUMULAR EL TOTAL

IF(@Y = @Y1)

SET @TOTAL += @MONTO

ELSE

-- SI NO COINCIDEN IMPRIMIR EL TOTAL, INICIALIZAR VARIABLES

 BEGIN

 PRINT 'IMPORTE EN:' +CAST(@Y1 AS VARCHAR) +

SPACE(2)+ 'ES ' +CAST(@TOTAL AS VARCHAR)

 PRINT 'A�O:' + CAST(@Y AS VARCHAR)

 SET @Y1=@Y

 SET @TOTAL=@MONTO

 END

-- IMPRIMIR EL REGISTRO

PRINT CAST(@PEDIDO AS VARCHAR) + SPACE(5)+STR(@MONTO)

-- LEER EL REGISTRO SIGUIENTE

FETCH MI_CURSOR INTO @Y, @PEDIDO, @MONTO

END

-- CERRAR

CLOSE MI_CURSOR

-- LIBERAR

DEALLOCATE MI_CURSOR;

-- IMPRIMIR LOS TOTALES FINALES

PRINT 'IMPORTE EN:'+CAST(@Y1 AS VARCHAR)+SPACE(2)+'ES '+STR(@TOTAL)